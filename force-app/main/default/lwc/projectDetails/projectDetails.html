<template>
    <section class="wrapper">
        <div class="container">
            <header class="header">
                <h2 class="slds-text-heading_medium">{projectName}</h2>
            </header>
            <div class=" slds-p-around_medium">
                <div class="header">
                    <div class="stats-cards">
                        <div class="card">
                            <div class="left">
                                <p class="card-title">Total Tasks</p>
                                <p class="card-value">{totalTasks}</p>
                            </div>
                            <div class="card-right">
                                <lightning-icon icon-name="standard:task" size="large"></lightning-icon>
                            </div>

                        </div>
                        <div class="card">
                            <div class="left">
                                <p class="card-title">Completed Tasks</p>
                                <p class="card-value">{completedTasks}</p>
                                <p class="card-btm">of {totalTasks} total</p>
                            </div>
                            <div class="card-right">
                                <lightning-icon icon-name="standard:task2" size="large"></lightning-icon>
                            </div>

                        </div>
                        <div class="card">
                            <div class="left">
                                <p class="card-title">In Progress Tasks</p>
                                <p class="card-value">{inProgressTasks}</p>
                            </div>
                            <div class="card-right">
                                <lightning-icon icon-name="standard:calibration" size="large"></lightning-icon>
                            </div>

                        </div>
                        <div class="card">
                            <div class="left">
                                <p class="card-title">Team Members</p>
                                <p class="card-value">{totalTeamMembers}</p>
                            </div>
                            <div class="card-right">
                                <lightning-icon icon-name="standard:groups" size="large"></lightning-icon>
                            </div>

                        </div>
                    </div>
                    <div class="btn">
                        <div class="priority-legend">
                            <span class="legend-item" data-priority="High" onclick={handleLegendClick}><span class="legend-color high"></span> High</span>
                            <span class="legend-item" data-priority="Medium" onclick={handleLegendClick}><span class="legend-color medium"></span> Medium</span>
                            <span class="legend-item" data-priority="Low" onclick={handleLegendClick}><span class="legend-color low"></span> Low</span>
                        </div>
                        <c-create-task project-id={projectId} ontaskcreated={handleTaskCreated}></c-create-task>
                        <lightning-button label="Manage Members" onclick={handleManageMembers}
                            variant="brand"></lightning-button>
                        <lightning-button label="Download Report" onclick={handleDownloadReport}
                            variant="brand" icon-name="utility:download"></lightning-button>
                    </div>
                    <template if:true={showManageMembersModal}>
                        <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="modal-heading-01"
                            class="slds-modal slds-fade-in-open modal">
                            <div class="slds-modal__container">
                                <header class="slds-modal__header">
                                    <h2 id="modal-heading-01" class="slds-text-heading_medium">Manage Members</h2>
                                </header>
                                <div class="slds-modal__content slds-p-around_medium">
                                    <div class="project-members">
                                        <h2>Project Members</h2>
                                        <lightning-datatable 
                                        key-field="Id" 
                                        data={teamMembers} 
                                        columns={teamMemberColumns}
                                        onrowselection={handleProjectMemberRowSelection}
                                        ></lightning-datatable>
                                        <div class="btn">
                                            <lightning-button label="Remove Selected" onclick={handleRemoveSelected}
                                                variant="brand"></lightning-button>
                                        </div>
                                    </div>
                                    <div class="available-members">
                                        <h2>Available Members</h2>
                                        <lightning-datatable 
                                            key-field="Id" 
                                            data={availableMembers} 
                                            columns={availableMemberColumns}
                                            onrowselection={handleRowSelection}
                                        ></lightning-datatable>
                                        <div class="btn">
                                            <lightning-button label="Add Selected" onclick={handleAddSelected}
                                                variant="brand"></lightning-button>
                                        </div>
                                    </div>
                                    
                                </div>
                                <footer class="slds-modal__footer">
                                    <lightning-button variant="neutral" label="Cancel"
                                        onclick={handleCancel}></lightning-button>
                                    <!-- <lightning-button variant="brand" label="Save" onclick={handleSave}></lightning-button> -->
                                </footer>
                            </div>
                        </section>
                    </template>
                </div>
                <div class="hero-section">
                    <!-- Epic Tabs -->
                    <div class="epic-tabs">
                        <template for:each={epicTabs} for:item="tab">
                            <button 
                                key={tab.id} 
                                class={tab.tabClass}
                                data-tab-id={tab.id}
                                onclick={handleEpicTabClick}>
                                {tab.name}
                            </button>
                        </template>
                    </div>
                    
                    <!-- Active Epic Filter -->
                    <template if:true={selectedEpicTask}>
                        <div class="active-epic-filter">
                            <div class="epic-filter-chip">
                                <lightning-icon icon-name="standard:task" size="x-small"></lightning-icon>
                                <span class="epic-filter-name">{selectedEpicTask.Name}</span>
                                <lightning-button-icon 
                                    icon-name="utility:close" 
                                    alternative-text="Remove filter"
                                    title="Remove Epic filter"
                                    variant="bare"
                                    size="small"
                                    onclick={handleClearEpicFilter}>
                                </lightning-button-icon>
                            </div>
                            <span class="epic-filter-label">Showing subtasks under this Epic</span>
                        </div>
                    </template>
                    
                    <div class="search-n-filter">
                        <div class="search">
                            <lightning-input type="search" label="Search" placeholder="Search by Task name"
                                value={searchKey}
                                onchange={handleSearchChange}></lightning-input>

                        </div>
                        <div class="filter">
                            <lightning-combobox name="priority-filter" value={selectedPriority} label="Priority"
                                placeholder="Select Priority"
                                options={priorityOptions} onchange={handlePriorityChange}></lightning-combobox>
                        </div>
                        <div class="filter">
                            <lightning-combobox name="assignee-filter" value={selectedAssignee} label="Assignee"
                                placeholder="Select Assignee"
                                options={assigneeOptions} onchange={handleAssigneeChange}></lightning-combobox>
                        </div>
                        <template if:true={hasActiveFilters}>
                            <div class="clear-filter-btn">
                                <lightning-button 
                                    label="Clear Filters" 
                                    variant="neutral" 
                                    icon-name="utility:clear"
                                    onclick={clearFilters}>
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                    <div class="hero-main">
                        <div class="kanban-container">
                            <template for:each={statusWithTasks} for:item="col">
                                <div key={col.status}
                                    class="kanban-column"
                                    data-status={col.status}    
                                    ondragover={handleDragOver}
                                    ondrop={handleDrop}
                                >
                                <h2 class="column-title">{col.status}</h2>
                                <template for:each={col.tasks} for:item="task">
                                    <div key={task.Id} class={task.cardClass}
                                        draggable="true"
                                        data-id={task.Id}
                                        data-record-type={task.RecordTypeId}
                                        data-is-epic={task.isEpic}
                                        ondragstart={handleDragStart}
                                        onclick={handleTaskCardClick}
                                        >
                                        <div class="task-card-header">
                                            <h3 class="task-title">{task.Name}</h3>
                                            <div class="task-actions">
                                                <lightning-button-icon 
                                                    icon-name="utility:preview" 
                                                    alternative-text="View Task"
                                                    title="View"
                                                    variant="bare"
                                                    size="small"
                                                    data-id={task.Id}
                                                    onclick={handleViewTask}>
                                                </lightning-button-icon>
                                                <lightning-button-icon 
                                                    icon-name="utility:edit" 
                                                    alternative-text="Edit Task"
                                                    title="Edit"
                                                    variant="bare"
                                                    size="small"
                                                    data-id={task.Id}
                                                    onclick={handleEditTask}>
                                                </lightning-button-icon>
                                                <lightning-button-icon 
                                                    icon-name="utility:delete" 
                                                    alternative-text="Delete Task"
                                                    title="Delete"
                                                    variant="bare"
                                                    size="small"
                                                    class="delete-icon"
                                                    data-id={task.Id}
                                                    onclick={handleDeleteTask}>
                                                </lightning-button-icon>
                                            </div>
                                        </div>
                                        <p class="task-priority">Priority: {task.Priority__c}</p>
                                        <p class="task-due-date">Due Date: {task.Due_Date__c}</p>
                                    </div>
                                </template>
                            </div>
                            </template>
                        </div>
                        <template if:true={showTaskDetailsModal}>
                            <c-task-details task-id={selectedTaskId} ontaskcreated={handleTaskCreated}></c-task-details>
                        </template>
                        
                        <!-- Delete Confirmation Modal -->
                        <template if:true={showDeleteConfirmModal}>
                            <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="delete-modal-heading" class="slds-modal slds-fade-in-open modal">
                                <div class="slds-modal__container delete-modal-container">
                                    <header class="slds-modal__header">
                                        <h2 id="delete-modal-heading" class="slds-text-heading_medium">Delete Task</h2>
                                    </header>
                                    <div class="slds-modal__content slds-p-around_medium">
                                        <p>Are you sure you want to delete this task? This action cannot be undone.</p>
                                    </div>
                                    <footer class="slds-modal__footer">
                                        <lightning-button variant="neutral" label="Cancel" onclick={handleDeleteCancel}></lightning-button>
                                        <lightning-button variant="destructive" label="Delete" onclick={handleDeleteConfirm}></lightning-button>
                                    </footer>
                                </div>
                            </section>
                        </template>
                        
                        <!-- View Task Modal (Read-only) -->
                        <template if:true={showViewTaskModal}>
                            <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="view-modal-heading" class="slds-modal slds-fade-in-open modal view-modal">
                                <div class="slds-modal__container">
                                    <header class="slds-modal__header">
                                        <h2 id="view-modal-heading" class="slds-text-heading_medium">Task Details</h2>
                                    </header>
                                    <div class="slds-modal__content slds-p-around_medium">
                                        <lightning-record-form
                                            object-api-name="Task__c"
                                            mode="readonly"
                                            record-id={selectedTaskId}
                                            fields={viewTaskFields}>
                                        </lightning-record-form>
                                    </div>
                                    <footer class="slds-modal__footer">
                                        <lightning-button variant="neutral" label="Close" onclick={handleViewTaskClose}></lightning-button>
                                    </footer>
                                </div>
                            </section>
                        </template>
                            
                    </div>
                </div>
            </div>

        </div>
        <div class="right">
            <div class="project-details">
                <h2>Project Details</h2>
                <lightning-record-form 
                record-id={projectId} 
                object-api-name="Project__c"
                fields={projectFields}
                onsuccess={handleProjectDetailsSuccess}
                >
                </lightning-record-form>
            </div>
        </div>

    </section>
</template>